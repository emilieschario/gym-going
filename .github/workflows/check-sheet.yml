name: Check Google Sheet Data

on:
  schedule:
    # Run every day at 8 AM ET (13:00 UTC)
    - cron: "0 13 * * *"
  workflow_dispatch:
  # Allow manual triggering

jobs:
  check-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "bun"
          
      - name: Install dependencies
        run: bun install
        
      - name: Fetch Google Sheet data
        run: |
          echo "Checking Google Sheet data..."
          curl -sL "https://docs.google.com/spreadsheets/d/1hjp8Ba90tuxwUuPHekV3xg2z1lX73gI0aZfwSIxSKJc/export?format=csv&gid=0" > sheet_data.csv
          echo "Sheet data fetched successfully!"
          echo "---"
          head -20 sheet_data.csv
          
      - name: Verify data format
        run: |
          if grep -q "TRUE" sheet_data.csv; then
            echo "✓ Data contains TRUE values"
          else
            echo "⚠ No TRUE values found in sheet"
          fi
          
          if grep -q "2026-01" sheet_data.csv; then
            echo "✓ January 2026 data found"
          else
            echo "⚠ No January 2026 data found"
          fi
          
      - name: Calculate ET timestamp
        id: timestamp
        run: |
          UTC_TIME=$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")
          ET_TIME=$(TZ='America/New_York' date +"%b %d, %Y, %l:%M %p ET")
          echo "utc_time=$UTC_TIME" >> $GITHUB_OUTPUT
          echo "et_time=$ET_TIME" >> $GITHUB_OUTPUT
          echo "Current time (ET): $ET_TIME"
          
      - name: Update timestamp file
        run: |
          cat > public/data-timestamp.json << EOF
          {
            "lastUpdated": "${{ steps.timestamp.outputs.utc_time }}",
            "lastUpdatedET": "${{ steps.timestamp.outputs.et_time }}"
          }
          EOF
          echo "Timestamp file updated!"
          cat public/data-timestamp.json
          
      - name: Upload sheet data as artifact
        uses: actions/upload-artifact@v4
        with:
          name: google-sheet-data
          path: sheet_data.csv
          retention-days: 7
          
      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update data timestamp via GitHub Action"
          file_pattern: public/data-timestamp.json
